# Asset Compiler

A command-line tool for compiling game assets from descriptor files into optimized runtime formats.

## Overview

The Asset Compiler is an **independent executable** that reads descriptor files generated by the AssetManager and compiles source assets into optimized binary formats for runtime use.

### Key Design Principles

1. **Independence** - Does not depend on the game engine, GLFW, OpenGL, or GUI systems
2. **Descriptor-Driven** - Reads all compilation settings from `Descriptor.txt` files
3. **Batch Processing** - Can compile hundreds of assets efficiently
4. **CI/CD Friendly** - Designed for automated build pipelines

## Architecture

```
Input Flow:
  1. Read Descriptor.txt → Get source path and compile settings
  2. Load source asset (e.g., rock.png)
  3. Process based on settings (compress, optimize, etc.)
  4. Output compiled binary (e.g., rock.texture)

Directory Structure:
  Resources/
  ├── Descriptors/              ← Input: Generated by AssetManager
  │   └── Texture/
  │       └── 03/40/5F7ED05B14224003/
  │           ├── Info.txt
  │           └── Descriptor.txt
  │
  └── Compiled/                 ← Output: Compiled assets
      └── Texture/
          └── 5F7ED05B14224003.texture
```

## Building

### Prerequisites
- CMake 3.20+
- C++17 compiler

### Build Steps

```bash
# From project root
mkdir build && cd build
cmake ..
cmake --build . --target AssetCompiler

# Output: build/bin/AssetCompiler[.exe]
```

### Build Only the Compiler (Faster)
```bash
cmake --build . --target AssetCompiler --config Release
```

## Usage

### Basic Usage
```bash
# Compile all assets with default settings
AssetCompiler

# Compile specific asset type
AssetCompiler --type texture

# Custom input/output paths
AssetCompiler --input Assets/Descriptors --output Build/Compiled
```

### Command Line Options

| Option | Description | Default |
|--------|-------------|---------|
| `--input <path>` | Path to Descriptors folder | `Resources/Descriptors/` |
| `--output <path>` | Path to output folder | `Resources/Compiled/` |
| `--type <type>` | Asset type: `all`, `texture`, `mesh`, `audio`, `shader` | `all` |
| `--threads <n>` | Number of worker threads | `4` |
| `--force` | Force recompile all (ignore timestamps) | `false` |
| `--verbose` | Enable verbose logging | `false` |
| `--help` | Show help message | - |

### Examples

```bash
# Compile only textures with verbose output
AssetCompiler --type texture --verbose

# Force recompile everything with 8 threads
AssetCompiler --force --threads 8

# Custom paths for CI/CD
AssetCompiler --input /project/Assets/Descriptors --output /build/output/Compiled
```

## Asset Types Supported

### 1. Textures (.png, .jpg, .tga, etc.)
**Input:** `Descriptor.txt` contains:
```json
{
  "sourcePath": "Resources/Sources/Textures/rock.png",
  "textureSettings": {
    "usageType": "COLOR",
    "compression": "BC7",
    "quality": 0.8,
    "generateMipmaps": true,
    "srgb": true
  }
}
```
**Output:** `5F7ED05B14224003.texture` (custom binary format)

### 2. Meshes (.obj, .fbx, etc.)
**Input:** Descriptor with mesh settings
**Output:** `.mesh` (custom binary format with vertex/index buffers)

### 3. Audio (.wav, .mp3, .ogg)
**Input:** Descriptor with audio settings
**Output:** `.audio` (optimized format, possibly converted)

### 4. Shaders (.glsl, .vert, .frag)
**Input:** Descriptor with shader compilation settings
**Output:** `.shader` (compiled SPIR-V or GLSL)

## Integration with Build Pipeline

### Option 1: Manual Compilation
```bash
# Developer runs this after modifying assets
cd build/bin
./AssetCompiler --verbose
```

### Option 2: CMake Post-Build Step (Future)
```cmake
# In root CMakeLists.txt
add_custom_target(CompileAssets
    COMMAND AssetCompiler --input ${CMAKE_SOURCE_DIR}/Resources/Descriptors
                         --output ${CMAKE_BINARY_DIR}/Resources/Compiled
    DEPENDS AssetCompiler
    COMMENT "Compiling game assets..."
)
```

### Option 3: CI/CD Pipeline
```yaml
# .github/workflows/build.yml
- name: Build Asset Compiler
  run: cmake --build build --target AssetCompiler

- name: Compile Assets
  run: ./build/bin/AssetCompiler --force --verbose
```

## Development Roadmap

### Phase 1: Core Infrastructure ✅ (Current)
- [x] Command-line argument parsing
- [x] Descriptor discovery system
- [x] Multi-threading placeholder
- [ ] Basic logging system

### Phase 2: Texture Compilation
- [ ] Parse texture descriptor settings
- [ ] Load source images (stb_image)
- [ ] Implement compression (BC7, DXT5)
- [ ] Generate mipmaps
- [ ] Write custom `.texture` format

### Phase 3: Mesh Compilation
- [ ] Parse mesh descriptor settings
- [ ] Load source meshes (Assimp/OpenFBX)
- [ ] Optimize vertex data
- [ ] Generate normals if missing
- [ ] Write custom `.mesh` format

### Phase 4: Audio Compilation
- [ ] Parse audio descriptor settings
- [ ] Load source audio (FMOD/libsndfile)
- [ ] Convert formats (WAV → OGG)
- [ ] Compress audio
- [ ] Write custom `.audio` format

### Phase 5: Shader Compilation
- [ ] Parse shader descriptor settings
- [ ] Load GLSL source
- [ ] Compile to SPIR-V (glslang)
- [ ] Optimize (spirv-opt)
- [ ] Write `.shader` format

### Phase 6: Advanced Features
- [ ] Incremental compilation (timestamp checking)
- [ ] Dependency tracking
- [ ] Parallel compilation with thread pool
- [ ] Progress bar
- [ ] Watch mode (recompile on file changes)

## Technical Details

### Why Not Use AssetManager/AssetDatabase?

The compiler is intentionally **independent** from the editor-time AssetManager:

| Concern | AssetManager | AssetCompiler |
|---------|--------------|---------------|
| **Purpose** | Scan source files, track changes, generate descriptors | Read descriptors, compile assets |
| **When** | Editor runtime | Build time |
| **Input** | Raw source files | Descriptor files |
| **Output** | Descriptor files | Compiled binaries |
| **Dependencies** | Many (scanning, GUID generation, database) | Minimal (file I/O, asset libraries) |

**Result:** Cleaner, faster, more suitable for CI/CD pipelines.

### Output Format Design

Each compiled asset is a binary file with:
```
Header:
  - Magic number (4 bytes)
  - Version (4 bytes)
  - Type (4 bytes)
  - Data size (8 bytes)
  - Metadata offset (8 bytes)

Data:
  - Raw compiled data (varies by type)

Metadata:
  - Original GUID (16 bytes)
  - Source path (string)
  - Compile timestamp (8 bytes)
  - Compiler version (4 bytes)
```

## Troubleshooting

### Descriptors not found
**Problem:** `No descriptors found to compile`
**Solution:** 
1. Run AssetManager first to generate descriptors
2. Check `--input` path points to `Descriptors/` folder
3. Verify descriptors have both `Info.txt` and `Descriptor.txt`

### Compilation fails
**Problem:** Individual assets fail to compile
**Solution:**
1. Use `--verbose` to see detailed error messages
2. Check source file exists at path in `Descriptor.txt`
3. Verify compile settings are valid

### Performance issues
**Problem:** Compilation is slow
**Solution:**
1. Increase threads: `--threads 16`
2. Use `--type` to compile only changed asset types
3. Disable `--force` to enable incremental compilation

## Contributing

### Adding a New Asset Type

1. **Create compiler class** in `CompilerCore/`
   ```cpp
   class MyAssetCompiler {
   public:
       bool compile(const DescriptorInfo& desc, const Config& cfg);
   };
   ```

2. **Add to main compilation loop** in `Main.cpp`
   ```cpp
   if (descriptor.resourceType == "MyAsset") {
       MyAssetCompiler compiler;
       success = compiler.compile(descriptor, config);
   }
   ```

3. **Update documentation** (this README)

### Code Style
- Follow existing code style (see engine code conventions)
- Comment complex algorithms
- Use descriptive variable names
- Keep functions short and focused

## License

Copyright (C) 2025 DigiPen Institute of Technology.

---

**Last Updated:** 2025
**Version:** 1.0.0
